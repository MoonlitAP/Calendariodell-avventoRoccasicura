<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, maximum-scale=1.0, user-scalable=no">
<title>üéÑ Giorno 3 ‚Äì Snowman Escape</title>

<link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&display=swap" rel="stylesheet">

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database-compat.js"></script>

<style>
body {
  margin: 0;
  background: #7b0412;
  font-family: 'Ubuntu', sans-serif;
  color: white;
  text-align: center;
  overflow-x: hidden;
}

h1 {
  color: #ffd700;
  margin-top: 10px;
}

/* CANVAS */
canvas {
  display: none;
  margin: 20px auto;
  border: 3px solid #ffd700;
  border-radius: 10px;
  background: #bde0fe;
  touch-action: none;
}

/* START SCREEN (come giorno 2) */
#start-screen {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.65);
  backdrop-filter: blur(5px);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9998;
}

.start-box {
  background: #fffaf2;
  padding: 30px;
  border-radius: 20px;
  width: 90%;
  max-width: 420px;
  border: 2px solid #ffd700;
  color: #400000;
  text-align: center;
}

.start-btn {
  width: 80%;
  margin-top: 12px;
  padding: 14px;
  border-radius: 30px;
  font-size: 1.1em;
  cursor: pointer;
  background: #7b0412;
  color: white;
  border: none;
  font-weight: bold;
}
.start-btn:hover {
  background: #ffd700;
  color: #400000;
}

/* COUNTDOWN */
#countdown {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.55);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.countdown-number {
  font-size: 6rem;
  font-weight: bold;
  color: #ffd700;
  text-shadow: 0 0 20px black;
  animation: zoomFade 1s ease forwards;
}

@keyframes zoomFade {
  0% { opacity: 0; transform: scale(0.4); }
  30% { opacity: 1; transform: scale(1); }
  100% { opacity: 0; transform: scale(2); }
}

/* END SCREEN (classifica finale come Giorno 2) */
#fine {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.65);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  backdrop-filter: blur(4px);
}

.classifica-box {
  background: #fffaf2;
  padding: 25px;
  border-radius: 20px;
  width: 90%;
  max-width: 460px;
  border: 2px solid #ffd700;
  color: #400000;
  text-align: center;
}

.btn {
  display: inline-block;
  margin-top: 15px;
  padding: 12px 30px;
  border-radius: 30px;
  font-weight: bold;
  cursor: pointer;
  color: white;
  background: #7b0412;
  text-decoration: none;
}
.btn:hover {
  background: #ffd700;
  color: #400000;
}

table {
  width: 100%;
  margin-top: 15px;
}
th, td {
  padding: 8px;
  border-bottom: 1px solid #d7bb5f;
  text-align: center;
}
</style>
</head>
<body>

<h1>üéÑ Giorno 3 ‚Äì Snowman Escape</h1>

<!-- START SCREEN -->
<div id="start-screen">
  <div class="start-box">
    <p>
      ‚ùÑ Evita i pupazzi<br>
      üéÅ Raccogli i regali<br>
      üéØ Spara le bamboline<br>
      ‚ù§Ô∏è 3 vite<br>
      üì± Tocca per salire<br>
      üßä Perfetto su telefono!
    </p>

    <button id="btn-start" class="start-btn">‚ñ∂Ô∏è INIZIA</button>
    <button id="btn-top10" class="start-btn" style="background:#b8860b;">üèÜ CLASSIFICA</button>
  </div>
</div>

<!-- COUNTDOWN -->
<div id="countdown">
  <div id="countdown-number" class="countdown-number">3</div>
</div>

<!-- GAME CANVAS -->
<canvas id="gameCanvas"></canvas>

<!-- END SCREEN -->
<div id="fine">
  <div class="classifica-box">
    <h2 id="messaggio"></h2>
    <h3>üèÜ Top 10 Globale</h3>

    <table id="score-table">
      <tr><th>Nome</th><th>Punti</th></tr>
    </table>

    <button id="retry-btn" class="btn" style="background:#d41e1e;">üîÑ Riprova</button>
    <a href="../calendario.html" class="btn">‚¨Ö Torna al Calendario</a>
  </div>
</div>
<script>
/* ======================================================
   FIREBASE CONFIG (sar√† completato in PARTE C)
====================================================== */
firebase.initializeApp({
  apiKey: "AIzaSyBrI1yThI6zmnYwKE4OHbS8vhrUPrMsnsk",
  authDomain: "calendarioroccasicura.firebaseapp.com",
  databaseURL: "https://calendarioroccasicura-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "calendarioroccasicura"
});

const db = firebase.database();

/* ======================================================
   NOME MASCHERATO COME GIORNO 2
====================================================== */
const nomeReale = localStorage.getItem("utente") || "Player";
const nomeMascherato =
  nomeReale[0] +
  Math.floor(Math.random() * 900 + 100) +
  nomeReale.slice(1);

/* ======================================================
   CANVAS
====================================================== */
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

function resizeCanvas() {
  const w = Math.min(window.innerWidth - 20, 420);
  const h = Math.floor(w * 1.6);
  canvas.width = w;
  canvas.height = h;
}
resizeCanvas();
window.addEventListener("resize", resizeCanvas);

/* ======================================================
   IMMAGINI
====================================================== */
const imgBabbo = new Image();
imgBabbo.src = "./img/babbo_3.png";

const imgSnowman = new Image();
imgSnowman.src = "./img/snowman.png";

const imgGift = new Image();
imgGift.src = "./img/gift.png";

const proiettiliSrc = ["./img/b1.png","./img/b2.png","./img/b3.png"];
let proiettiliImg = [];
proiettiliSrc.forEach(src => { let i = new Image(); i.src = src; proiettiliImg.push(i); });

/* ======================================================
   PARAMETRI DI GIOCO
====================================================== */
let babbo = { x: 40, y: 0, w: 70, h: 70, vy: 0 };
let touching = false;

let snowmen = [];
let gifts = [];
let bullets = [];
let reteAttiva = false;
let reteTimer = 0;

let score = 0;
let lives = 3;
let running = false;

/* ======================================================
   CONTROLLO MOVIMENTO (TAP ‚Üí Vola, Rilascio ‚Üí Scende)
====================================================== */
canvas.addEventListener("touchstart", () => touching = true);
canvas.addEventListener("touchend",   () => touching = false);
canvas.addEventListener("mousedown",  () => touching = true);
canvas.addEventListener("mouseup",    () => touching = false);

function moveBabbo() {
  if (touching) babbo.vy = -4;
  else babbo.vy = 4;

  babbo.y += babbo.vy;

  if (babbo.y < 0) babbo.y = 0;
  if (babbo.y + babbo.h > canvas.height) babbo.y = canvas.height - babbo.h;
}

/* ======================================================
   SPAWN PUPAZZI
====================================================== */
let spawnSnowmanTimer = 0;

function spawnSnowman() {
  snowmen.push({
    x: canvas.width + 40,
    y: Math.random() * (canvas.height - 120),
    w: 90,
    h: 90,
    speed: 2
  });
}

/* ======================================================
   SPAWN REGALI
====================================================== */
let spawnGiftTimer = 0;

function spawnGift() {
  gifts.push({
    x: canvas.width + 40,
    y: Math.random() * (canvas.height - 120),
    w: 60,
    h: 60,
    speed: 2
  });
}

/* ======================================================
   SPARA (BAMBOLINE)
====================================================== */
function spara() {
  const img = proiettiliImg[Math.floor(Math.random()*proiettiliImg.length)];

  bullets.push({
    x: babbo.x + babbo.w,
    y: babbo.y + babbo.h / 2 - 20,
    w: 40,
    h: 40,
    speed: 6,
    img: img
  });
}

/* ======================================================
   COLLISIONE RETTANGOLARE
====================================================== */
function coll(a,b) {
  return (
    a.x < b.x + b.w &&
    a.x + a.w > b.x &&
    a.y < b.y + b.h &&
    a.y + a.h > b.y
  );
}

/* ======================================================
   GAME LOOP PRINCIPALE
====================================================== */
function updateGame() {
  if (!running) return;

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  /* Babbo */
  moveBabbo();
  ctx.drawImage(imgBabbo, babbo.x, babbo.y, babbo.w, babbo.h);

  /* SPAWN PUPAZZI */
  spawnSnowmanTimer++;
  if (spawnSnowmanTimer > 80) {
    spawnSnowman();
    spawnSnowmanTimer = 0;
  }

  /* SPAWN REGALI */
  spawnGiftTimer++;
  if (spawnGiftTimer > 200) {
    spawnGift();
    spawnGiftTimer = 0;
  }

  /* --------------------------------------
     PUPAZZI DI NEVE
  -------------------------------------- */
  snowmen.forEach((s, si) => {
    s.x -= s.speed;
    ctx.drawImage(imgSnowman, s.x, s.y, s.w, s.h);

    /* Collisione con Babbo */
    if (coll(babbo, s)) {
      lives--;
      snowmen.splice(si,1);

      if (lives <= 0) return gameOver();

    }

    /* Rete attiva ‚Üí meno 30 punti */
    if (reteAttiva && reteTimer > 0) {
      const rete = { x: babbo.x + babbo.w + 10, y: babbo.y, w: 130, h: babbo.h };

      ctx.strokeStyle = "rgba(255,255,255,0.4)";
      ctx.strokeRect(rete.x, rete.y, rete.w, rete.h);

      if (coll(rete, s)) {
        score -= 30;
        if (score < 0) score = 0;
        snowmen.splice(si, 1);
      }
    }
  });

  /* Timer rete */
  if (reteTimer > 0) {
    reteTimer--;
    if (reteTimer === 0) reteAttiva = false;
  }

  /* --------------------------------------
     REGALI
  -------------------------------------- */
  gifts.forEach((g, gi) => {
    g.x -= g.speed;
    ctx.drawImage(imgGift, g.x, g.y, g.w, g.h);

    if (coll(babbo, g)) {
      gifts.splice(gi,1);
      reteAttiva = true;
      reteTimer = 70;
    }
  });

  /* --------------------------------------
     PROIETTILI
  -------------------------------------- */
  bullets.forEach((p, pi) => {
    p.x += p.speed;
    ctx.drawImage(p.img, p.x, p.y, p.w, p.h);

    if (p.x > canvas.width + 50) bullets.splice(pi,1);

    snowmen.forEach((s, si) => {
      if (coll(p, s)) {
        score += 50;
        snowmen.splice(si,1);
        bullets.splice(pi,1);
      }
    });
  });

  /* Testo punteggio */
  ctx.fillStyle = "white";
  ctx.font = "18px Ubuntu";
  ctx.fillText("Punteggio: " + score, 20, 30);
  ctx.fillText("‚ù§Ô∏è " + lives, 20, 60);

  requestAnimationFrame(updateGame);
}

/* ======================================================
   FINE PARTE B
   Ora serve PARTE C ‚Üí countdown, start, firebase classifica
====================================================== */
</script>





    <script>
/* ======================================================
   GAME OVER ‚Üí mostra popup e salva su Firebase
====================================================== */
function gameOver() {
  running = false;

  document.getElementById("fine").style.display = "flex";
  document.getElementById("messaggio").textContent =
    `Hai totalizzato ${score} punti!`;

  /* Salva punteggio su Firebase giorno3 */
  db.ref("punteggi/giorno3").push({
    nome: nomeMascherato,
    punti: score,
    timestamp: Date.now()
  });

  caricaClassifica();
}

/* ======================================================
   CLASSIFICA GLOBALE TOP 10
====================================================== */
function caricaClassifica() {
  const table = document.getElementById("score-table");
  table.innerHTML = "<tr><th>Nome</th><th>Punti</th></tr>";

  db.ref("punteggi/giorno3")
    .orderByChild("punti")
    .limitToLast(10)
    .once("value", snap => {

      let arr = [];
      snap.forEach(child => arr.push(child.val()));

      arr.sort((a,b) => b.punti - a.punti);

      arr.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${r.nome}</td><td>${r.punti}</td>`;
        table.appendChild(tr);
      });
    });
}

/* ======================================================
   COUNTDOWN VISUALE
====================================================== */
function startCountdown(cb) {
  const c = document.getElementById("countdown");
  const num = document.getElementById("countdown-number");

  let n = 3;
  c.style.display = "flex";
  num.textContent = n;

  const timer = setInterval(() => {
    n--;

    if (n > 0) {
      num.textContent = n;
    } else {
      num.textContent = "VIA!";
      setTimeout(() => {
        clearInterval(timer);
        c.style.display = "none";
        cb();
      }, 500);
    }
  }, 1000);
}

/* ======================================================
   START GAME
====================================================== */
function avviaGioco() {
  document.getElementById("start-screen").style.display = "none";
  canvas.style.display = "block";

  running = true;
  updateGame();
}

/* INIZIARE IL GIOCO */
document.getElementById("btn-start").addEventListener("click", () => {
  startCountdown(avviaGioco);
});

/* MOSTRARE CLASSIFICA DAL MENU */
document.getElementById("btn-top10").addEventListener("click", () => {
  document.getElementById("start-screen").style.display = "none";
  document.getElementById("fine").style.display = "flex";
  caricaClassifica();
});

/* RICOMINCIARE */
document.getElementById("retry-btn").addEventListener("click", () => {
  location.reload();
});
</script>

</body>
</html>
